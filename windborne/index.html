<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Windborne Balloon Missions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    h1 {
      margin: 0;
      padding: 0.5rem;
      background-color: #004481;
      color: #ffffff;
      font-size: 1.5rem;
    }
    #map {
      width: 100%;
      height: calc(100vh - 2.5rem);
    }
    .legend {
      background: rgba(255, 255, 255, 0.85);
      padding: 8px;
      line-height: 1.3em;
      color: #222;
      font-size: 0.9rem;
    }
    .legend h4 {
      margin: 4px 0;
      font-size: 1rem;
    }
    .legend svg {
      vertical-align: middle;
    }
    /* Modal styles for displaying recovery photos */
    #recoveryModal {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.8);
    }
    #recoveryModal .modal-content {
      position: relative;
      margin: 5% auto;
      max-width: 80%;
      background-color: #fefefe;
      padding: 1rem;
      border-radius: 4px;
    }
    #recoveryModal img {
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 0.5rem;
    }
    #recoveryModal .close {
      color: #aaa;
      float: right;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
    }
    #recoveryModal .close:hover,
    #recoveryModal .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }
    #recoveryModal .caption {
      font-size: 0.9rem;
      color: #333;
    }
    a.recovery-link {
      color: #007bc1;
      text-decoration: underline;
      cursor: pointer;
    }
    a.recovery-link:hover {
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1>Windborne Balloon Missions</h1>
  <div id="map"></div>
  <!-- Modal element for recovery images -->
  <div id="recoveryModal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <img id="recoveryImg" src="" alt="Recovery photo" />
      <div id="recoveryCaption" class="caption"></div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    function formatDate(isoString) {
      if (!isoString) return 'N/A';
      const date = new Date(isoString);
      return date.toLocaleString(undefined, { timeZoneName: 'short' });
    }
    const map = L.map('map').setView([20, 0], 2);
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19,
    }).addTo(map);
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
      maxZoom: 19,
    });
    const landedLayer = L.layerGroup();
    const inflightLayer = L.layerGroup();
    const missionLookup = {};

    // This API does not require a key to use as of Oct 2025
    // However, it does require a CORS bypass.
    fetch('https://api.codetabs.com/v1/proxy?quest=https://landed.windbornesystems.com/api/missions')
      .then((response) => {
        if (!response.ok) {
          throw new Error('Failed to fetch mission data: ' + response.status);
        }
        return response.json();
      })
      .then((data) => {
        const missions = data.missions || [];
        // Determine altitude range for colour mapping.
        let minAlt = Infinity;
        let maxAlt = -Infinity;
        missions.forEach((mission) => {
          const alt = mission.analysis && typeof mission.analysis.altitude === 'number' ? mission.analysis.altitude : null;
          if (alt != null) {
            if (alt < minAlt) minAlt = alt;
            if (alt > maxAlt) maxAlt = alt;
          }
        });
        if (!isFinite(minAlt) || !isFinite(maxAlt) || minAlt === maxAlt) {
          minAlt = 0;
          maxAlt = 1;
        }

        function getColorForAltitude(alt) {
          if (typeof alt !== 'number') return '#999999';
          const t = (alt - minAlt) / (maxAlt - minAlt);
          const clamped = Math.max(0, Math.min(1, t));
          const hue = 240 - 240 * clamped;
          return `hsl(${hue}, 100%, 50%)`;
        }
        // Marker style takes into account landing status and recovery status.
        function markerStyle(landed, recovered, colour) {
          return {
            radius: landed ? 7 : 4,
            fillColor: colour,
            color: recovered ? '#ed1909' : '#000000',
            weight: landed ? 2 : 1,
            opacity: 1,
            fillOpacity: 0.7,
          };
        }
        missions.forEach((mission) => {
          const analysis = mission.analysis || {};
          const processed = mission.processed || {};
          const lat = analysis.latitude;
          const lon = analysis.longitude;
          // Skip invalid coordinates.
          if (lat === null || lon === null || isNaN(lat) || isNaN(lon)) {
            return;
          }
          const altitude = analysis.altitude;
          const colour = getColorForAltitude(altitude);
          const landed = analysis.landing_detected === true || !!mission.landing_time;
          const recovered = mission.is_recovered === true;
          const style = markerStyle(landed, recovered, colour);
          const marker = L.circleMarker([lat, lon], style);
          // Store mission details for later retrieval.
          missionLookup[mission.id] = mission;
          // Build rich popup content.
          let popupHtml = '';
          popupHtml += `<strong>${mission.name || 'Unnamed mission'}</strong><br />`;
          popupHtml += `<em>Mission code:</em> ${processed.code || 'N/A'}<br />`;
          popupHtml += `<em>Tag:</em> ${processed.tag || 'N/A'}<br />`;
          popupHtml += `<em>Location:</em> ${processed.landname || 'Unknown'}<br />`;
          popupHtml += `<em>Coordinates:</em> <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}">${lat || 'Unknown'}, ${lon || 'Unknown'}</a><br />`;
          popupHtml += `<em>Biome:</em> ${processed.biome || 'Unknown'}<br />`;
          popupHtml += `<em>Launch time:</em> ${formatDate(mission.launch_time)}<br />`;
          popupHtml += `<em>Landing time:</em> ${formatDate(mission.landing_time)}<br />`;
          popupHtml += `<em>Recovered at:</em> ${formatDate(mission.recovered_at)}<br />`;
          popupHtml += `<em>Altitude:</em> ${altitude != null ? altitude + ' m' : 'N/A'}<br />`;
          popupHtml += `<em>Ascent rate:</em> ${analysis.ascent_rate != null ? analysis.ascent_rate + ' m/s' : 'N/A'}<br />`;
          popupHtml += `<em>Speed:</em> ${analysis.speed != null ? analysis.speed + ' m/s' : 'N/A'}<br />`;
          popupHtml += `<em>Heading:</em> ${analysis.heading != null ? analysis.heading + '°' : 'N/A'}<br />`;
          popupHtml += `<em>Battery:</em> ${mission.battery_percent != null ? mission.battery_percent + '%' : 'N/A'}<br />`;
          popupHtml += `<em>Voltage:</em> ${mission.voltage != null ? mission.voltage + ' V' : 'N/A'}<br />`;
          popupHtml += `<em>Internal temperature:</em> ${mission.internal_temperature != null ? mission.internal_temperature + '°C' : 'N/A'}<br />`;
          popupHtml += `<em>Pressure:</em> ${mission.pressure != null ? mission.pressure + ' hPa' : 'N/A'}<br />`;
          popupHtml += `<em>GPS satellites:</em> ${mission.gps_satellites != null ? mission.gps_satellites : 'N/A'}<br />`;
          popupHtml += `<em>Landing detected:</em> ${analysis.landing_detected ? 'Yes' : 'No'}<br />`;
          popupHtml += `<em>Recovered:</em> ${recovered ? '<span style="color:#ed1909;">Yes</span>' : 'No'}<br />`;
          if (mission.recovery_alias) {
            popupHtml += `<em>Recoverer:</em> ${mission.recovery_alias}<br />`;
          }
          if (mission.recovery_text) {
            popupHtml += `<em>Recovery notes:</em> ${mission.recovery_text}<br />`;
          }
          if (recovered && mission.recovery_image_url) {
            popupHtml += `<a href="#" class="recovery-link" data-mission-id="${mission.id}">View recovery photo</a>`;
          }
          marker.bindPopup(popupHtml);
          // Add marker to the appropriate layer.
          if (landed) {
            landedLayer.addLayer(marker);
          } else {
            inflightLayer.addLayer(marker);
          }
        });
        // Add layers to the map.
        landedLayer.addTo(map);
        inflightLayer.addTo(map);
        const baseLayers = {
          'Street map': osmLayer,
          'Satellite imagery': satelliteLayer,
        };
        const overlays = {
          'Landed missions': landedLayer,
          'In‑flight missions': inflightLayer,
        };
        L.control.layers(baseLayers, overlays, { collapsed: false, position: 'topright' }).addTo(map);
        // Legend: altitude colour scale, landing status, recovery status.
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function () {
          const div = L.DomUtil.create('div', 'legend');
          let html = '';
          html += '<h4>Altitude</h4>';
          html += '<div style="width:140px;height:10px;background: linear-gradient(to right, hsl(240,100%,50%), hsl(0,100%,50%));"></div>';
          html += '<div style="display:flex; justify-content: space-between; font-size:0.8rem;"><span>Low</span><span>High</span></div>';
          html += '<h4>Landing status</h4>';
          html += '<svg width="14" height="14" style="margin-right:6px;"><circle cx="7" cy="7" r="4" fill="gray" stroke="#000" stroke-width="1"></circle></svg>In flight<br />';
          html += '<svg width="14" height="14" style="margin-right:6px;"><circle cx="7" cy="7" r="7" fill="gray" stroke="#000" stroke-width="2"></circle></svg>Landed<br />';
          html += '<h4>Recovery status</h4>';
          html += '<svg width="14" height="14" style="margin-right:6px;"><circle cx="7" cy="7" r="5" fill="gray" stroke="#000" stroke-width="1"></circle></svg>Not recovered<br />';
          html += '<svg width="14" height="14" style="margin-right:6px;"><circle cx="7" cy="7" r="5" fill="gray" stroke="#ed1909" stroke-width="1"></circle></svg>Recovered';
          div.innerHTML = html;
          return div;
        };
        legend.addTo(map);
      })
      .catch((error) => {
        console.error('Error loading missions:', error);
      });

    // Modal behaviour: open when a recovery link is clicked, close on click of
    // the X or outside the modal.
    function showRecoveryModal(src, caption) {
      const modal = document.getElementById('recoveryModal');
      const imgElem = document.getElementById('recoveryImg');
      const captionElem = document.getElementById('recoveryCaption');
      imgElem.src = src;
      captionElem.textContent = caption || '';
      modal.style.display = 'block';
    }
    function hideRecoveryModal() {
      const modal = document.getElementById('recoveryModal');
      modal.style.display = 'none';
      // Clear the image to prevent stale images showing if the next one fails.
      document.getElementById('recoveryImg').src = '';
      document.getElementById('recoveryCaption').textContent = '';
    }
    // Delegate click events for recovery links.
    document.addEventListener('click', function (event) {
      if (event.target && event.target.classList.contains('recovery-link')) {
        event.preventDefault();
        const missionId = event.target.getAttribute('data-mission-id');
        const mission = missionLookup[missionId];
        if (mission && mission.recovery_image_url) {
          const captionParts = [];
          if (mission.recovery_alias) captionParts.push('Recovered by ' + mission.recovery_alias);
          if (mission.recovery_text) captionParts.push(mission.recovery_text);
          showRecoveryModal(mission.recovery_image_url, captionParts.join(' — '));
        }
      }
    });
    // Close modal when clicking the close button or outside the modal content.
    document.getElementById('recoveryModal').addEventListener('click', function (e) {
      const modalContent = document.querySelector('#recoveryModal .modal-content');
      if (e.target.classList.contains('close') || !modalContent.contains(e.target)) {
        hideRecoveryModal();
      }
    });
  </script>
</body>
</html>
